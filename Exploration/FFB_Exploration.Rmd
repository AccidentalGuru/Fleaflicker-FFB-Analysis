---
title: "Fantasy Football Data Exploration"
output: 
  html_notebook:
    code_folding: hide
    toc: true
    toc_float: true
---

# Introduction

The following is an analysis of the "Will Carter Bowl" fantasy football league. The data was scraped from FleaFlicker.com using an automated python script. 

The goal is to answer the following questions:

  * How many team names is too many team names?
  * What are the positional strengths and weakness of each team? How have they changed over time?
  * Is it possible to quantify how terrible Jim is as a human and as a fantasy football manager?
  * Is it possible to prove that my (Joe's) lack of success is due to a statistical anomaly? 
  * How impactful are defense and kickers to the outcome of the league?
  * What are some performance metrics for managers (efficiency, etc)
    * Efficiency
    * Variation
  * How do teams/managers compare when it comes to the number of transactions?
  * Can the difference in strength between the starting lineup and bench be an indicator for success?
  * Analyze the positional age of the players on teams
  * Matchup Analysis
    * All time head to head matchups
      * Actual matchups
      * If you played eachother every week
    * Everyone vs. Everyone Standings
    * Weekly Unlucky Index
    * Losing/Winning Streaks


# Setup

## Load and Install Packages

```{r include=FALSE}
ipak <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE)
    suppressWarnings(suppressMessages(sapply(pkg, require, character.only = TRUE)))
}

ipak(c("tidyverse", "skimr"))
```

## Import/Clean Data

**Load Data**
```{r}
df.stats <- read.csv("../Data/points.csv", header = TRUE)
```

**Update Data Types**
```{r}
df.stats$team_id <- as.factor(df.stats$team_id)
df.stats$manager_id <- as.factor(df.stats$manager_id)
df.stats$player_id <- as.factor(df.stats$player_id)
df.stats$season <- as.factor(df.stats$season)
df.stats$week <- as.factor(df.stats$week)
```

**Sort Data**
```{r}
df.stats <- df.stats %>%
  arrange(season, week, team_id, set_pos, player_pos, player_name)
```

**Review Data**
```{r eval=FALSE, include=FALSE}
skim(df.stats)
```

```{r}

# Check that the scraping was completed for all seasons/weeks
tmp.check <- df.stats %>%
  select(team_id, season, week) %>%
  distinct() %>%
  group_by(team_id) %>%
  summarise(count_weeks = n())

if(unique(tmp.check$count_weeks) > 1) {print("ERROR:  Missing Data")}
```

**Build Reference Table for Current Team Names & Managers**
```{r}
df.teams <- df.stats %>%
  group_by(team_id) %>%
  arrange(season, week) %>%
  summarise(manager_id_cur = last(manager_id),
            manager_name_cur = last(manager_name),
            team_name_cur = last(team_name))
  
```


# Analysis {.tabset}

## Team Name Insecurity 

```{r}
# Gather team name data
df.teamnames <- df.stats %>%
  select(manager_name, team_name) %>%
  distinct() %>%
  group_by(manager_name) %>%
  summarise(Count = n(),
            Names = paste0(team_name, collapse = ", ")) %>%
  arrange(desc(Count)) %>%
  rename(Manager = manager_name)

```

```{r}
#Plot team names
ggplot(df.teamnames, aes(x = reorder(Manager, Count), y = Count)) +
  geom_bar(stat = "identity", fill = "lightsteelblue4", alpha = 0.5) +
  geom_text(aes(x = Manager, y = 0.1, label = Names, hjust = 0, vjust = 0), size = 2.5, col = "black") +
  theme_classic() +
  labs(title = "Team Name Insecurity") +
  xlab("Manager") +
  ylab("Number of Team Names") +
  theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()

```


## Positional Strength

**Strategy**
  * Compile weekly performance (by team) of players for a selected position
  * Use the "top n" players for the position (i.e. top 3 WR, top 2 RB, top 1 QB, etc.)
    * This reduces noise from managers not playing optimal lineups
  * Measure the positional performance of each team relative to entire league
  * Measure positional performance over time
  * Compare positional performance of starters versus bench
  * Find way to visualize positional strength for every team and every position on one chart
    * x axis = 

**Prepare Data**
```{r}

# Define Player Position Limits
df.pos.lim <- data.frame("player_pos" = c("QB", "RB", "WR", "TE", "K", "D/ST"),
                         "pos_lim" = c(1,2,3,1,1,1))

# Initialize data frame for collecting starter results
df.stats.toppos <- data.frame()

# Gather stats from top n starters from each position
for (i in 1:nrow(df.pos.lim)) {
  
  #Define position/limit for each player position
  pos = df.pos.lim[i, "player_pos"]
  lim = df.pos.lim[i,"pos_lim"]
  
  # Filter and select top n players
  tmp.stats.toppos <- df.stats %>%
    filter(! set_pos %in% c("BN", "IR", "TAXI")) %>%
    filter(player_pos == pos) %>%
    filter(as.integer(week) <= 13) %>%
    group_by(team_id, season, week) %>%
    top_n(lim, points) %>%
    ungroup() %>%
    left_join(df.teams %>% select(team_id, manager_name_cur), by="team_id") %>%
    select(Manager = manager_name_cur,
           Season = season,
           Week = week,
           Position = player_pos,
           Player = player_name,
           Points = points)
  
  # Compile Results
  df.stats.toppos <- rbind(df.stats.toppos, tmp.stats.toppos)
}

# Initialize data frame for collecting starter results
df.stats.topben <- data.frame()

# Gather stats from top bench player for each position
for (i in 1:nrow(df.pos.lim)) {
  
  #Define position/limit for each player position
  pos = df.pos.lim[i, "player_pos"]
  lim = 1
  
  # Filter and select top n players
  tmp.stats.topben <- df.stats %>%
    filter(set_pos %in% c("BN", "TAXI")) %>%
    filter(player_pos == pos) %>%
    filter(as.integer(week) <= 13) %>%
    group_by(team_id, season, week) %>%
    top_n(lim, points) %>%
    ungroup() %>%
    left_join(df.teams %>% select(team_id, manager_name_cur), by="team_id") %>%
    select(Manager = manager_name_cur,
           Season = season,
           Week = week,
           Position = player_pos,
           Player = player_name,
           Points = points)
  
  # Compile Results
  df.stats.topben <- rbind(df.stats.topben, tmp.stats.topben)
}

```

**Plot Starter Positional Strength Over Time (Teams by Position)**
```{r}

# Loop through managers
for (manager in unique(df.stats.toppos$Manager)){
  
  # Define temporary plot data
  tmp.plot <- df.stats.toppos %>%
    filter(Manager == manager) %>%
    filter(Position != "K") %>%
    arrange(Season, Week) %>%
    mutate(Week = paste0(Season, "-", Week)) %>%
    mutate(Week = factor(Week, ordered = TRUE))

  # Create Plot
  p <- ggplot(tmp.plot, aes(x = as.integer(Week), y = Points, col = Position)) +
    geom_smooth(method = 'loess', formula = 'y ~ x',level = 0.5, span = .8, alpha = 0.2) +
    geom_vline(xintercept = seq(13, as.integer(max(tmp.plot$Week)), 13), alpha = 0.2) +
    theme_classic() +
    labs(title = paste("Starting Positional Strength Over Time", " - ", manager)) +
    xlab("Weeks") +
    ylab("Points") +
    ylim(c(0,30)) +
    theme(plot.title = element_text(hjust = 0.5))
  
  # Print Plot
  print(p)
  
}
```

**Plot Bench Positional Strength Over Time (Teams by Position)**
```{r}

# Loop through managers
for (manager in unique(df.stats.toppos$Manager)){
  
  # Define temporary plot data
  tmp.plot <- df.stats.topben %>%
    filter(Manager == manager) %>%
    filter(! Position %in% c("K", "D/ST")) %>%
    arrange(Season, Week) %>%
    mutate(Week = paste0(Season, "-", Week)) %>%
    mutate(Week = factor(Week, ordered = TRUE))

  # Create Plot
  p <- ggplot(tmp.plot, aes(x = as.integer(Week), y = Points, col = Position)) +
    geom_smooth(method = 'loess', formula = 'y ~ x',level = 0.5, span = .8, alpha = 0.2) +
    geom_vline(xintercept = seq(13, as.integer(max(tmp.plot$Week)), 13), alpha = 0.2) +
    theme_classic() +
    labs(title = paste("Bench Positional Strength Over Time", " - ", manager)) +
    xlab("Weeks") +
    ylab("Points") +
    ylim(c(0,30)) +
    theme(plot.title = element_text(hjust = 0.5))
  
  # Print Plot
  print(p)
  
}
```

**Plot Starter Positional Strength Over Time (Positions by Team)**
```{r}

# Create list of positions, excluding kickers
positions <- unique(df.stats.toppos$Position)
positions <- positions[positions != "K"]

# Loop through positions
for (pos in positions){
  
  # Define temporary plot data
  tmp.plot <- df.stats.toppos %>%
    filter(Position == pos) %>%
    filter(Position != "K") %>%
    arrange(Season, Week) %>%
    mutate(Week = paste0(Season, "-", Week)) %>%
    mutate(Week = factor(Week, ordered = TRUE))
  
  # Create Plot
  p <- ggplot(tmp.plot, aes(x = as.integer(Week), y = Points, col = Manager)) +
    geom_smooth(level = 0.5, span = 0.8, alpha = 0.1) +
    geom_vline(xintercept = seq(13, as.integer(max(tmp.plot$Week)), 13), alpha = 0.2) +
    theme_classic() +
    labs(title = paste("Starting Positional Strength Over Time", " - ", pos)) +
    xlab("Weeks") +
    ylab("Points") +
    theme(plot.title = element_text(hjust = 0.5))
  
  # Print Plot
  print(p)
  
}
```


**Plot Bench Positional Strength Over Time (Positions by Team)**
```{r}

# Create list of positions, excluding kickers
positions <- c("QB", "RB", "WR", "TE")

# Loop through positions
for (pos in positions){
  
  # Define temporary plot data
  tmp.plot <- df.stats.topben %>%
    filter(Position == pos) %>%
    filter(Position %in% positions) %>%
    arrange(Season, Week) %>%
    mutate(Week = paste0(Season, "-", Week)) %>%
    mutate(Week = factor(Week, ordered = TRUE))
  
  # Create Plot
  p <- ggplot(tmp.plot, aes(x = as.integer(Week), y = Points, col = Manager)) +
    geom_smooth(level = 0.5, span = 0.8, alpha = 0.1) +
    geom_vline(xintercept = seq(13, as.integer(max(tmp.plot$Week)), 13), alpha = 0.2) +
    theme_classic() +
    labs(title = paste("Bench Positional Strength Over Time", " - ", pos)) +
    xlab("Weeks") +
    ylab("Points") +
    theme(plot.title = element_text(hjust = 0.5))
  
  # Print Plot
  print(p)
  
}
```

